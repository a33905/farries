<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>仙聲奪人</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 防止選取與觸控預設行為，優化行動裝置體驗 */
        * {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        @keyframes pulse-heart {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }

        .animate-heart {
            animation: pulse-heart 1.2s ease-in-out infinite;
        }

        .touch-none {
            touch-action: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 fixed inset-0 flex flex-col items-center justify-center p-6 overflow-hidden touch-none">

    <div id="app" class="max-w-md w-full text-center space-y-8">
        <!-- 標題與狀態區 -->
        <div class="space-y-4">
            <h1 class="text-3xl font-black tracking-[0.2em] text-white flex items-center justify-center gap-3">
                <span class="text-purple-400">✨</span>
                仙聲奪人
                <span class="text-purple-400">✨</span>
            </h1>
            <div id="status-message" class="transition-all py-3 px-8 rounded-2xl inline-block text-sm font-bold border bg-slate-800 border-slate-700 text-slate-400 shadow-lg min-h-[3rem]">
                請選出仙女的天籟之音
            </div>
        </div>

        <!-- 聲音選項網格 (3x2 佈局) -->
        <div id="options-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 w-full">
            <!-- 由 JavaScript 動態生成按鈕 -->
        </div>

        <!-- 操作按鈕 -->
        <button id="verify-btn" class="w-full py-6 rounded-3xl bg-gradient-to-r from-purple-700 to-indigo-700 text-white font-black text-xl tracking-[0.3em] shadow-2xl active:scale-95 disabled:opacity-50 transition-all">
            確 定 答 案
        </button>
    </div>

    <script>
        // 本地音檔路徑配置
        const AUDIO_FILES = {
            '1': '1.mp3',
            '2': '2.mp3',
            '3': '3.mp3',
            '4': '4.mp3',
            'correct': 'correct.mp3'
        };

        const FAIRIES_DATA = [
            { id: 'f1', audioKey: '1' },
            { id: 'f2', audioKey: '2' },
            { id: 'f3', audioKey: '3' },
            { id: 'f4', audioKey: '4' },
            { id: 'f5', audioKey: 'correct' }
        ];

        let options = [];
        let targetId = null;
        let selectedId = null;
        let selectedAudioKey = null; 
        let status = 'idle';
        let currentAudio = null;
        let longPressTimer = null;
        let isLongPress = false;

        const grid = document.getElementById('options-grid');
        const statusMsg = document.getElementById('status-message');
        const verifyBtn = document.getElementById('verify-btn');

        // 初始化遊戲：洗牌並設定目標
        function shuffleGame() {
            options = [...FAIRIES_DATA].sort(() => Math.random() - 0.5);
            const target = options.find(f => f.audioKey === 'correct');
            targetId = target.id;
            selectedId = null;
            selectedAudioKey = null;
            status = 'idle';
            updateStatus("請選出仙女的天籟之音", "idle");
            renderGrid();
        }

        // 更新 UI 狀態文字
        function updateStatus(msg, type) {
            statusMsg.innerText = msg;
            statusMsg.className = "transition-all py-3 px-8 rounded-2xl inline-block text-sm font-bold border shadow-lg ";
            
            if (type === "correct") {
                statusMsg.classList.add("bg-green-500/20", "text-green-400", "border-green-500");
            } else if (type === "wrong") {
                statusMsg.classList.add("bg-red-500/20", "text-red-400", "border-red-500", "animate-shake");
            } else {
                statusMsg.classList.add("bg-slate-800", "border-slate-700", "text-slate-400");
            }
        }

        // 渲染選項網格
        function renderGrid() {
            grid.innerHTML = '';
            options.forEach((fairy, index) => {
                const btn = document.createElement('button');
                const isSelected = selectedId === fairy.id;
                
                btn.className = `relative flex items-center justify-center rounded-[2rem] py-6 transition-all duration-500 border-2 outline-none ${
                    isSelected ? 'bg-pink-900/40 border-pink-500 scale-105 shadow-[0_0_30px_rgba(236,72,153,0.3)]' : 'bg-slate-800 border-slate-700'
                }`;

                // 動態切換圖示：選中為愛心，未選中為音量
                const icon = isSelected ? 
                    `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor" class="text-pink-400 animate-heart"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>` :
                    `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>`;

                btn.innerHTML = `
                    <div class="flex flex-col items-center gap-2">
                        ${icon}
                        <span class="text-[10px] tracking-tighter text-slate-600 font-mono uppercase">SENS-0${index + 1}</span>
                    </div>
                `;

                // 處理長按選取邏輯
                const handleStart = (e) => {
                    if (status === 'correct') return;
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        selectedId = fairy.id;
                        selectedAudioKey = fairy.audioKey;
                        updateStatus("已選取此聲音", "idle");
                        renderGrid();
                        if (navigator.vibrate) navigator.vibrate(50);
                    }, 600);
                };

                const handleEnd = (e) => {
                    clearTimeout(longPressTimer);
                    if (!isLongPress && status !== 'correct') {
                        playAudio(fairy.audioKey);
                    }
                };

                btn.addEventListener('mousedown', handleStart);
                btn.addEventListener('mouseup', handleEnd);
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e); }, {passive: false});
                btn.addEventListener('touchend', (e) => { e.preventDefault(); handleEnd(e); }, {passive: false});

                grid.appendChild(btn);
            });
        }

        // 播放選中的音檔
        function playAudio(key) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            const url = AUDIO_FILES[key];
            if (url) {
                currentAudio = new Audio(url);
                currentAudio.play().catch(err => console.warn("播放受阻，請確保已有使用者互動。"));
            }
        }

        // 驗證答案
        verifyBtn.addEventListener('click', () => {
            if (status === 'correct') return;
            if (!selectedId) {
                updateStatus("請先長按一個方塊進行選取", "idle");
                return;
            }

            if (selectedId === targetId) {
                status = 'correct';
                updateStatus("正確！即將進入驚喜頁面 ✨", "correct");
                verifyBtn.innerText = "驗 證 通 過";
                verifyBtn.classList.add('bg-green-600');
                
                // 跳轉至成功頁面
                setTimeout(() => {
                    window.location.href = 'correct.html';
                }, 10);
            } else {
                updateStatus("不對噢！即將前往失敗頁面...", "wrong");
                // 跳轉至失敗頁面，傳遞選錯的音檔 ID，檔名格式改為 ID_wrong.mp3
                setTimeout(() => {
                    window.location.href = `wrong.html?id=${selectedAudioKey}_wrong`;
                }, 10);
            }
        });

        window.onload = shuffleGame;
    </script>
</body>
</html>
